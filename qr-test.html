<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRç¢¼æƒææ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-danger {
            background: #dc3545;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
        }
        #scanContainer {
            text-align: center;
            margin: 20px 0;
        }
        #scan {
            width: 300px;
            height: 300px;
            border: 2px solid #007bff;
            border-radius: 10px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            font-weight: bold;
        }
        .qr-display {
            margin: 20px 0;
            text-align: center;
        }
        .qr-display img {
            border: 2px solid #007bff;
            border-radius: 10px;
        }
        #scanError {
            margin: 10px 0;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            color: #856404;
        }
        .error-details {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .debug-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” QRç¢¼æƒææ¸¬è©¦å·¥å…·</h1>
    
    <div class="test-section">
        <h2>1. ç€è¦½å™¨ç›¸å®¹æ€§æ¸¬è©¦</h2>
        <button class="btn" onclick="testBrowserCompatibility()">æ¸¬è©¦ç€è¦½å™¨æ”¯æ´</button>
        <div id="browserResult"></div>
    </div>

    <div class="test-section">
        <h2>2. ç›¸æ©Ÿæ¬Šé™æ¸¬è©¦</h2>
        <button class="btn" onclick="testCameraPermission()">æ¸¬è©¦ç›¸æ©Ÿæ¬Šé™</button>
        <div id="cameraResult"></div>
    </div>

    <div class="test-section">
        <h2>3. QRç¢¼ç”Ÿæˆæ¸¬è©¦</h2>
        <button class="btn" onclick="generateTestQR()">ç”Ÿæˆæ¸¬è©¦QRç¢¼</button>
        <div id="qrResult" class="qr-display"></div>
    </div>

    <div class="test-section">
        <h2>4. QRç¢¼æƒææ¸¬è©¦</h2>
        <button class="btn btn-success" onclick="startScanning()">é–‹å§‹æƒæ</button>
        <button class="btn btn-danger" onclick="stopScanning()">åœæ­¢æƒæ</button>
        <button class="btn" onclick="retryScanning()">é‡è©¦æƒæ</button>
        <button class="btn" onclick="listCameras()">åˆ—å‡ºç›¸æ©Ÿ</button>
        <div id="cameraList"></div>
        <div id="scanContainer">
            <div class="status" id="scanStatus">æº–å‚™æƒæ...</div>
            <div id="scanError" style="display: none;"></div>
            <video id="scan"></video>
        </div>
        <div id="scanResult"></div>
    </div>

    <div class="test-section">
        <h2>5. å•é¡Œè¨ºæ–·</h2>
        <button class="btn" onclick="runDiagnostics()">åŸ·è¡Œå®Œæ•´è¨ºæ–·</button>
        <div id="diagnosticsResult"></div>
    </div>

    <!-- å¤–éƒ¨åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

    <script>
        let codeReader = null;
        let isScanning = false;

        // æ¸¬è©¦ç€è¦½å™¨ç›¸å®¹æ€§
        function testBrowserCompatibility() {
            const result = document.getElementById('browserResult');
            let html = '';

            // æª¢æŸ¥ getUserMedia æ”¯æ´
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                html += '<div class="result success">âœ… getUserMedia API æ”¯æ´</div>';
            } else {
                html += '<div class="result error">âŒ getUserMedia API ä¸æ”¯æ´</div>';
            }

            // æª¢æŸ¥ WebRTC æ”¯æ´
            if (window.RTCPeerConnection || window.webkitRTCPeerConnection) {
                html += '<div class="result success">âœ… WebRTC æ”¯æ´</div>';
            } else {
                html += '<div class="result error">âŒ WebRTC ä¸æ”¯æ´</div>';
            }

            // æª¢æŸ¥ QRCode.js
            if (typeof QRCode !== 'undefined') {
                html += '<div class="result success">âœ… QRCode.js è¼‰å…¥æˆåŠŸ</div>';
            } else {
                html += '<div class="result error">âŒ QRCode.js è¼‰å…¥å¤±æ•—</div>';
            }

            // æª¢æŸ¥ ZXing
            if (typeof ZXing !== 'undefined') {
                html += '<div class="result success">âœ… ZXing è¼‰å…¥æˆåŠŸ</div>';
            } else {
                html += '<div class="result error">âŒ ZXing è¼‰å…¥å¤±æ•—</div>';
            }

            // æª¢æŸ¥ LZString
            if (typeof LZString !== 'undefined') {
                html += '<div class="result success">âœ… LZString è¼‰å…¥æˆåŠŸ</div>';
            } else {
                html += '<div class="result error">âŒ LZString è¼‰å…¥å¤±æ•—</div>';
            }

            result.innerHTML = html;
        }

        // æ¸¬è©¦ç›¸æ©Ÿæ¬Šé™
        async function testCameraPermission() {
            const result = document.getElementById('cameraResult');
            let html = '';

            try {
                html += '<div class="result info">æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...</div>';
                result.innerHTML = html;

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });

                html += '<div class="result success">âœ… ç›¸æ©Ÿæ¬Šé™ç²å¾—æˆåŠŸ</div>';
                
                // æª¢æŸ¥ç›¸æ©Ÿè³‡è¨Š
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) {
                    const capabilities = videoTrack.getCapabilities();
                    html += `<div class="result success">âœ… ç›¸æ©Ÿ: ${videoTrack.label}</div>`;
                    html += `<div class="result success">âœ… è§£æåº¦: ${capabilities.width.max}x${capabilities.height.max}</div>`;
                }

                // åœæ­¢æ¸¬è©¦æµ
                stream.getTracks().forEach(track => track.stop());
                html += '<div class="result success">âœ… ç›¸æ©Ÿæ¸¬è©¦å®Œæˆ</div>';

            } catch (error) {
                html += `<div class="result error">âŒ ç›¸æ©Ÿæ¬Šé™éŒ¯èª¤: ${error.message}</div>`;
                
                if (error.name === 'NotAllowedError') {
                    html += '<div class="result error">ğŸ’¡ è«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±ç›¸æ©Ÿæ¬Šé™</div>';
                } else if (error.name === 'NotFoundError') {
                    html += '<div class="result error">ğŸ’¡ æ‰¾ä¸åˆ°ç›¸æ©Ÿè¨­å‚™</div>';
                } else if (error.name === 'NotSupportedError') {
                    html += '<div class="result error">ğŸ’¡ ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½</div>';
                }
            }

            result.innerHTML = html;
        }

        // ç”Ÿæˆæ¸¬è©¦QRç¢¼
        function generateTestQR() {
            const result = document.getElementById('qrResult');
            
            // ç”Ÿæˆæ¸¬è©¦è³‡æ–™
            const testData = {
                type: 'test',
                timestamp: Date.now(),
                message: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦QRç¢¼'
            };
            
            const compressed = LZString.compressToBase64(JSON.stringify(testData));
            
            // æ¸…é™¤ä¹‹å‰çš„QRç¢¼
            result.innerHTML = '';
            
            // ç”Ÿæˆæ–°çš„QRç¢¼
            const qr = new QRCode(result, {
                text: compressed,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L
            });
            
            result.innerHTML += `<div class="result success">âœ… æ¸¬è©¦QRç¢¼ç”ŸæˆæˆåŠŸ</div>`;
            result.innerHTML += `<div class="result info">æ¸¬è©¦è³‡æ–™: ${compressed.substring(0, 50)}...</div>`;
        }

        // é–‹å§‹æƒæ
        async function startScanning() {
            if (isScanning) {
                return;
            }

            const statusElement = document.getElementById('scanStatus');
            const errorElement = document.getElementById('scanError');
            const resultElement = document.getElementById('scanResult');
            const videoElement = document.getElementById('scan');
            
            // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤
            errorElement.style.display = 'none';
            errorElement.innerHTML = '';
            resultElement.innerHTML = '';
            
            try {
                isScanning = true;
                statusElement.textContent = 'æ­£åœ¨æª¢æŸ¥æƒæå™¨åº«...';
                
                // æª¢æŸ¥ ZXing æ˜¯å¦å¯ç”¨
                if (typeof ZXing === 'undefined') {
                    throw new Error('ZXing åº«æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                }

                statusElement.textContent = 'æ­£åœ¨å‰µå»ºæƒæå™¨...';
                
                // å‰µå»º ZXing æƒæå™¨å¯¦ä¾‹
                codeReader = new ZXing.BrowserMultiFormatReader();
                
                statusElement.textContent = 'æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...';
                
                // å•Ÿå‹•æƒæå™¨
                await codeReader.decodeFromVideoDevice(
                    null, // ä½¿ç”¨é è¨­ç›¸æ©Ÿ
                    videoElement,
                    (result, error) => {
                        if (result) {
                            // æƒææˆåŠŸ
                            const decodedText = result.getText();
                            statusElement.textContent = 'æƒææˆåŠŸï¼';
                            resultElement.innerHTML = `
                                <div class="result success">
                                    <strong>æƒæçµæœ:</strong><br>
                                    <pre>${decodedText}</pre>
                                </div>
                            `;
                            
                            // å˜—è©¦è§£æè³‡æ–™
                            try {
                                const decompressed = LZString.decompressFromBase64(decodedText);
                                const parsed = JSON.parse(decompressed);
                                resultElement.innerHTML += `
                                    <div class="result success">
                                        <strong>è§£æçµæœ:</strong><br>
                                        <pre>${JSON.stringify(parsed, null, 2)}</pre>
                                    </div>
                                `;
                            } catch (e) {
                                resultElement.innerHTML += `
                                    <div class="result error">
                                        <strong>è§£æå¤±æ•—:</strong> ${e.message}
                                    </div>
                                `;
                            }
                            
                            stopScanning();
                        }
                        
                        if (error && error.name !== 'NotFoundException') {
                            // æƒæéŒ¯èª¤ï¼ˆéè‡´å‘½ï¼‰
                            statusElement.textContent = 'æ­£åœ¨æƒæï¼Œè«‹å°æº–QRç¢¼...';
                        }
                    }
                );

                statusElement.textContent = 'æƒæå™¨å·²å•Ÿå‹•ï¼Œè«‹å°æº–QRç¢¼';

            } catch (error) {
                console.error('æƒæå™¨å•Ÿå‹•å¤±æ•—:', error);
                isScanning = false;
                statusElement.textContent = 'æƒæå™¨å•Ÿå‹•å¤±æ•—';
                
                // åœ¨é é¢ä¸Šé¡¯ç¤ºè©³ç´°éŒ¯èª¤
                let errorMessage = error.message;
                let errorDetails = '';
                let solution = '';

                // æ ¹æ“šéŒ¯èª¤é¡å‹æä¾›å…·é«”å»ºè­°
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'ç›¸æ©Ÿæ¬Šé™è¢«æ‹’çµ•';
                    errorDetails = 'ç€è¦½å™¨æ‹’çµ•äº†ç›¸æ©Ÿæ¬Šé™è«‹æ±‚';
                    solution = 'è«‹é»æ“Šç¶²å€åˆ—å·¦å´çš„ç›¸æ©Ÿåœ–ç¤ºå…è¨±æ¬Šé™ï¼Œæˆ–é‡æ–°è¼‰å…¥é é¢';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'æ‰¾ä¸åˆ°ç›¸æ©Ÿè¨­å‚™';
                    errorDetails = 'ç³»çµ±ç„¡æ³•æ‰¾åˆ°å¯ç”¨çš„ç›¸æ©Ÿè¨­å‚™';
                    solution = 'è«‹ç¢ºèªè¨­å‚™æœ‰ç›¸æ©Ÿï¼Œä¸”æ²’æœ‰è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = 'ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½';
                    errorDetails = 'ç•¶å‰ç€è¦½å™¨ä¸æ”¯æ´getUserMedia API';
                    solution = 'è«‹ä½¿ç”¨Chromeã€Firefoxã€Safariæˆ–Edgeç€è¦½å™¨';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'ç›¸æ©Ÿè¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½”ç”¨';
                    errorDetails = 'ç›¸æ©Ÿæ­£åœ¨è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨';
                    solution = 'è«‹é—œé–‰å…¶ä»–ä½¿ç”¨ç›¸æ©Ÿçš„æ‡‰ç”¨ç¨‹å¼ï¼ˆå¦‚ç›¸æ©Ÿã€è¦–è¨Šé€šè©±ç­‰ï¼‰';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage = 'ç›¸æ©Ÿé…ç½®ä¸æ”¯æ´';
                    errorDetails = 'è«‹æ±‚çš„ç›¸æ©Ÿé…ç½®ä¸è¢«è¨­å‚™æ”¯æ´';
                    solution = 'è«‹å˜—è©¦é‡æ–°è¼‰å…¥é é¢æˆ–ä½¿ç”¨ä¸åŒçš„ç€è¦½å™¨';
                } else if (error.message.includes('ZXing')) {
                    errorMessage = 'æƒæå™¨åº«è¼‰å…¥å¤±æ•—';
                    errorDetails = 'ç„¡æ³•è¼‰å…¥ZXingåº«';
                    solution = 'è«‹æª¢æŸ¥ç¶²è·¯é€£æ¥ï¼Œé‡æ–°è¼‰å…¥é é¢';
                } else if (error.message.includes('HTTPS')) {
                    errorMessage = 'éœ€è¦HTTPSé€£æ¥';
                    errorDetails = 'ç›¸æ©ŸåŠŸèƒ½éœ€è¦å®‰å…¨çš„HTTPSé€£æ¥';
                    solution = 'è«‹ä½¿ç”¨HTTPSç¶²å€æˆ–localhost';
                } else if (error.message.includes('permission')) {
                    errorMessage = 'æ¬Šé™å•é¡Œ';
                    errorDetails = error.message;
                    solution = 'è«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±ç›¸æ©Ÿæ¬Šé™';
                } else if (error.message.includes('decodeFromVideoDevice')) {
                    errorMessage = 'æƒæå™¨å•Ÿå‹•å¤±æ•—';
                    errorDetails = 'ZXingå•Ÿå‹•éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤';
                    solution = 'è«‹å˜—è©¦é‡æ–°è¼‰å…¥é é¢æˆ–ä½¿ç”¨ä¸åŒçš„ç€è¦½å™¨';
                }

                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                errorElement.innerHTML = `
                    <div class="result error">
                        <strong>éŒ¯èª¤é¡å‹:</strong> ${errorMessage}<br>
                        <strong>éŒ¯èª¤è©³æƒ…:</strong> ${errorDetails}<br>
                        <strong>è§£æ±ºæ–¹æ¡ˆ:</strong> ${solution}<br>
                        <strong>éŒ¯èª¤åç¨±:</strong> ${error.name}<br>
                        <strong>å®Œæ•´éŒ¯èª¤:</strong><br>
                        <div class="error-details">${error.stack || error.message}</div>
                    </div>
                `;
                errorElement.style.display = 'block';
            }
        }

        // åœæ­¢æƒæ
        function stopScanning() {
            const statusElement = document.getElementById('scanStatus');
            const videoElement = document.getElementById('scan');
            
            if (codeReader && isScanning) {
                codeReader.reset();
            }
            
            // åœæ­¢ç›¸æ©Ÿæµ
            if (videoElement.srcObject) {
                const stream = videoElement.srcObject;
                stream.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            
            isScanning = false;
            statusElement.textContent = 'æƒæå·²åœæ­¢';
        }

        // é‡è©¦æƒæ
        function retryScanning() {
            startScanning();
        }

        // åˆ—å‡ºå¯ç”¨ç›¸æ©Ÿ
        async function listCameras() {
            const cameraListElement = document.getElementById('cameraList');
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length === 0) {
                    cameraListElement.innerHTML = '<div class="result error">âŒ æ‰¾ä¸åˆ°ç›¸æ©Ÿè¨­å‚™</div>';
                    return;
                }
                
                let html = '<div class="result info"><strong>å¯ç”¨ç›¸æ©Ÿ:</strong></div>';
                videoDevices.forEach((device, index) => {
                    html += `
                        <div class="result info">
                            <strong>ç›¸æ©Ÿ ${index + 1}:</strong> ${device.label || `ç›¸æ©Ÿ ${index + 1}`}<br>
                            <button class="btn" onclick="startScanningWithCamera('${device.deviceId}')">ä½¿ç”¨æ­¤ç›¸æ©Ÿ</button>
                        </div>
                    `;
                });
                
                cameraListElement.innerHTML = html;
                
            } catch (error) {
                cameraListElement.innerHTML = `
                    <div class="result error">
                        âŒ ç„¡æ³•åˆ—å‡ºç›¸æ©Ÿ: ${error.message}
                    </div>
                `;
            }
        }

        // ä½¿ç”¨æŒ‡å®šç›¸æ©Ÿé–‹å§‹æƒæ
        async function startScanningWithCamera(deviceId) {
            if (isScanning) {
                stopScanning();
            }
            
            const statusElement = document.getElementById('scanStatus');
            const errorElement = document.getElementById('scanError');
            const resultElement = document.getElementById('scanResult');
            const videoElement = document.getElementById('scan');
            
            // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤
            errorElement.style.display = 'none';
            errorElement.innerHTML = '';
            resultElement.innerHTML = '';
            
            try {
                isScanning = true;
                statusElement.textContent = 'æ­£åœ¨æª¢æŸ¥æƒæå™¨åº«...';
                
                // æª¢æŸ¥ ZXing æ˜¯å¦å¯ç”¨
                if (typeof ZXing === 'undefined') {
                    throw new Error('ZXing åº«æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                }

                statusElement.textContent = 'æ­£åœ¨å‰µå»ºæƒæå™¨...';
                
                // å‰µå»º ZXing æƒæå™¨å¯¦ä¾‹
                codeReader = new ZXing.BrowserMultiFormatReader();
                
                statusElement.textContent = 'æ­£åœ¨å•Ÿå‹•æŒ‡å®šç›¸æ©Ÿ...';
                
                // å•Ÿå‹•æƒæå™¨ï¼Œä½¿ç”¨æŒ‡å®šçš„ç›¸æ©Ÿ
                await codeReader.decodeFromVideoDevice(
                    deviceId,
                    videoElement,
                    (result, error) => {
                        if (result) {
                            // æƒææˆåŠŸ
                            const decodedText = result.getText();
                            statusElement.textContent = 'æƒææˆåŠŸï¼';
                            resultElement.innerHTML = `
                                <div class="result success">
                                    <strong>æƒæçµæœ:</strong><br>
                                    <pre>${decodedText}</pre>
                                </div>
                            `;
                            
                            // å˜—è©¦è§£æè³‡æ–™
                            try {
                                const decompressed = LZString.decompressFromBase64(decodedText);
                                const parsed = JSON.parse(decompressed);
                                resultElement.innerHTML += `
                                    <div class="result success">
                                        <strong>è§£æçµæœ:</strong><br>
                                        <pre>${JSON.stringify(parsed, null, 2)}</pre>
                                    </div>
                                `;
                            } catch (e) {
                                resultElement.innerHTML += `
                                    <div class="result error">
                                        <strong>è§£æå¤±æ•—:</strong> ${e.message}
                                    </div>
                                `;
                            }
                            
                            stopScanning();
                        }
                        
                        if (error && error.name !== 'NotFoundException') {
                            // æƒæéŒ¯èª¤ï¼ˆéè‡´å‘½ï¼‰
                            statusElement.textContent = 'æ­£åœ¨æƒæï¼Œè«‹å°æº–QRç¢¼...';
                        }
                    }
                );

                statusElement.textContent = 'æƒæå™¨å·²å•Ÿå‹•ï¼Œè«‹å°æº–QRç¢¼';

            } catch (error) {
                console.error('æƒæå™¨å•Ÿå‹•å¤±æ•—:', error);
                isScanning = false;
                statusElement.textContent = 'æƒæå™¨å•Ÿå‹•å¤±æ•—';
                
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                errorElement.innerHTML = `
                    <div class="result error">
                        <strong>éŒ¯èª¤é¡å‹:</strong> ${error.message}<br>
                        <strong>éŒ¯èª¤è©³æƒ…:</strong> ä½¿ç”¨æŒ‡å®šç›¸æ©Ÿæ™‚ç™¼ç”ŸéŒ¯èª¤<br>
                        <strong>è§£æ±ºæ–¹æ¡ˆ:</strong> è«‹å˜—è©¦ä½¿ç”¨é è¨­ç›¸æ©Ÿæˆ–é‡æ–°è¼‰å…¥é é¢<br>
                        <strong>å®Œæ•´éŒ¯èª¤:</strong><br>
                        <div class="error-details">${error.stack || error.message}</div>
                    </div>
                `;
                errorElement.style.display = 'block';
            }
        }

        // åŸ·è¡Œå®Œæ•´è¨ºæ–·
        async function runDiagnostics() {
            const result = document.getElementById('diagnosticsResult');
            let html = '<div class="result info">æ­£åœ¨åŸ·è¡Œè¨ºæ–·...</div>';
            result.innerHTML = html;

            const issues = [];
            const suggestions = [];

            // 1. æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                issues.push('ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½');
                suggestions.push('è«‹ä½¿ç”¨ Chromeã€Firefoxã€Safari æˆ– Edge ç€è¦½å™¨');
            } else {
                html += '<div class="result success">âœ… ç€è¦½å™¨æ”¯æ´ç›¸æ©ŸåŠŸèƒ½</div>';
            }

            // 2. æª¢æŸ¥HTTPS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                issues.push('ç›¸æ©ŸåŠŸèƒ½éœ€è¦HTTPSé€£æ¥ï¼ˆlocalhosté™¤å¤–ï¼‰');
                suggestions.push('è«‹ä½¿ç”¨ HTTPS ç¶²å€æˆ–éƒ¨ç½²åˆ°æ”¯æ´ HTTPS çš„ä¼ºæœå™¨');
            } else {
                html += '<div class="result success">âœ… é€£æ¥å”è­°æ­£ç¢º</div>';
            }

            // 3. æª¢æŸ¥GitHub Pagesç‰¹å®šå•é¡Œ
            if (location.hostname.includes('github.io')) {
                html += '<div class="result info">â„¹ï¸ æª¢æ¸¬åˆ°GitHub Pageséƒ¨ç½²</div>';
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ­£ç¢ºçš„HTTPS
                if (location.protocol === 'https:') {
                    html += '<div class="result success">âœ… GitHub Pages HTTPS æ­£ç¢º</div>';
                } else {
                    issues.push('GitHub Pageséœ€è¦HTTPSé€£æ¥');
                    suggestions.push('è«‹ä½¿ç”¨ https:// é–‹é ­çš„ç¶²å€');
                }
                
                // æª¢æŸ¥æª”æ¡ˆè·¯å¾‘
                if (location.pathname.includes('/index.html') || location.pathname.endsWith('/')) {
                    html += '<div class="result success">âœ… æª”æ¡ˆè·¯å¾‘æ­£ç¢º</div>';
                } else {
                    issues.push('å¯èƒ½ä¸æ˜¯æ­£ç¢ºçš„å…¥å£é é¢');
                    suggestions.push('è«‹ç¢ºèªè¨ªå•çš„æ˜¯æ­£ç¢ºçš„ç¶²å€');
                }
            }

            // 4. æª¢æŸ¥åº«è¼‰å…¥
            if (typeof ZXing === 'undefined') {
                issues.push('ZXingåº«è¼‰å…¥å¤±æ•—');
                suggestions.push('è«‹æª¢æŸ¥ç¶²è·¯é€£æ¥ï¼Œé‡æ–°è¼‰å…¥é é¢');
            } else {
                html += '<div class="result success">âœ… ZXingåº«è¼‰å…¥æˆåŠŸ</div>';
            }

            if (typeof QRCode === 'undefined') {
                issues.push('QRCode.jsåº«è¼‰å…¥å¤±æ•—');
                suggestions.push('è«‹æª¢æŸ¥ç¶²è·¯é€£æ¥ï¼Œé‡æ–°è¼‰å…¥é é¢');
            } else {
                html += '<div class="result success">âœ… QRCode.jsåº«è¼‰å…¥æˆåŠŸ</div>';
            }

            // 5. æª¢æŸ¥ç€è¦½å™¨ç‰ˆæœ¬
            const userAgent = navigator.userAgent;
            if (userAgent.includes('Chrome')) {
                const version = userAgent.match(/Chrome\/(\d+)/);
                if (version && parseInt(version[1]) < 53) {
                    issues.push('Chromeç‰ˆæœ¬éèˆŠï¼Œå»ºè­°å‡ç´šåˆ°æœ€æ–°ç‰ˆæœ¬');
                    suggestions.push('è«‹æ›´æ–° Chrome ç€è¦½å™¨åˆ°æœ€æ–°ç‰ˆæœ¬');
                } else {
                    html += '<div class="result success">âœ… Chromeç‰ˆæœ¬æ”¯æ´</div>';
                }
            } else if (userAgent.includes('Firefox')) {
                const version = userAgent.match(/Firefox\/(\d+)/);
                if (version && parseInt(version[1]) < 36) {
                    issues.push('Firefoxç‰ˆæœ¬éèˆŠï¼Œå»ºè­°å‡ç´šåˆ°æœ€æ–°ç‰ˆæœ¬');
                    suggestions.push('è«‹æ›´æ–° Firefox ç€è¦½å™¨åˆ°æœ€æ–°ç‰ˆæœ¬');
                } else {
                    html += '<div class="result success">âœ… Firefoxç‰ˆæœ¬æ”¯æ´</div>';
                }
            } else if (userAgent.includes('Safari')) {
                const version = userAgent.match(/Version\/(\d+)/);
                if (version && parseInt(version[1]) < 11) {
                    issues.push('Safariç‰ˆæœ¬éèˆŠï¼Œå»ºè­°å‡ç´šåˆ°æœ€æ–°ç‰ˆæœ¬');
                    suggestions.push('è«‹æ›´æ–° Safari ç€è¦½å™¨åˆ°æœ€æ–°ç‰ˆæœ¬');
                } else {
                    html += '<div class="result success">âœ… Safariç‰ˆæœ¬æ”¯æ´</div>';
                }
            }

            // 6. æ¸¬è©¦ç›¸æ©Ÿæ¬Šé™
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                // æª¢æŸ¥ç›¸æ©Ÿè³‡è¨Š
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) {
                    html += `<div class="result success">âœ… ç›¸æ©Ÿæ¬Šé™ç²å¾—æˆåŠŸ</div>`;
                    html += `<div class="result success">âœ… ç›¸æ©Ÿ: ${videoTrack.label}</div>`;
                    
                    const capabilities = videoTrack.getCapabilities();
                    if (capabilities) {
                        html += `<div class="result success">âœ… è§£æåº¦æ”¯æ´: ${capabilities.width.max}x${capabilities.height.max}</div>`;
                    }
                }
                
                // åœæ­¢æ¸¬è©¦æµ
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                issues.push(`ç›¸æ©Ÿæ¬Šé™å•é¡Œ: ${error.message}`);
                
                if (error.name === 'NotAllowedError') {
                    suggestions.push('è«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±ç›¸æ©Ÿæ¬Šé™ï¼Œæˆ–é»æ“Šç¶²å€åˆ—å·¦å´çš„ç›¸æ©Ÿåœ–ç¤ºå…è¨±æ¬Šé™');
                } else if (error.name === 'NotFoundError') {
                    suggestions.push('è«‹ç¢ºèªè¨­å‚™æœ‰ç›¸æ©Ÿï¼Œä¸”æ²’æœ‰è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨');
                } else if (error.name === 'NotSupportedError') {
                    suggestions.push('è«‹ä½¿ç”¨æ”¯æ´çš„ç€è¦½å™¨ï¼ˆChromeã€Firefoxã€Safariç­‰ï¼‰');
                } else if (error.name === 'NotReadableError') {
                    suggestions.push('ç›¸æ©Ÿå¯èƒ½è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½”ç”¨ï¼Œè«‹é—œé–‰å…¶ä»–ä½¿ç”¨ç›¸æ©Ÿçš„æ‡‰ç”¨ç¨‹å¼');
                }
            }

            // 7. æª¢æŸ¥è¨­å‚™é¡å‹
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)) {
                html += '<div class="result success">âœ… æª¢æ¸¬åˆ°ç§»å‹•è¨­å‚™</div>';
                
                // æª¢æŸ¥Chromeç§»å‹•ç‰ˆç‰¹å®šå•é¡Œ
                if (userAgent.includes('Chrome') && /Android|iPhone|iPad|iPod/i.test(userAgent)) {
                    html += '<div class="result info">â„¹ï¸ æª¢æ¸¬åˆ°Chromeç§»å‹•ç‰ˆ</div>';
                    
                    // æª¢æŸ¥Chromeç‰ˆæœ¬
                    const chromeVersion = userAgent.match(/Chrome\/(\d+)/);
                    if (chromeVersion && parseInt(chromeVersion[1]) < 53) {
                        issues.push('Chromeç§»å‹•ç‰ˆç‰ˆæœ¬éèˆŠ');
                        suggestions.push('è«‹æ›´æ–°Chromeåˆ°æœ€æ–°ç‰ˆæœ¬');
                    }
                }
            } else {
                html += '<div class="result info">â„¹ï¸ æª¢æ¸¬åˆ°æ¡Œé¢è¨­å‚™ï¼Œå»ºè­°ä½¿ç”¨æ‰‹æ©Ÿæ¸¬è©¦</div>';
            }

            // 8. é¡¯ç¤ºè©³ç´°çš„èª¿è©¦è³‡è¨Š
            html += `
                <div class="debug-info">
                    <strong>èª¿è©¦è³‡è¨Š:</strong><br>
                    ç¶²å€: ${location.href}<br>
                    å”è­°: ${location.protocol}<br>
                    ä¸»æ©Ÿ: ${location.hostname}<br>
                    è·¯å¾‘: ${location.pathname}<br>
                    ç”¨æˆ¶ä»£ç†: ${userAgent.substring(0, 100)}...<br>
                    è¢å¹•è§£æåº¦: ${screen.width}x${screen.height}<br>
                    è¦–çª—å¤§å°: ${window.innerWidth}x${window.innerHeight}
                </div>
            `;

            // é¡¯ç¤ºçµæœ
            if (issues.length === 0) {
                html += '<div class="result success">âœ… æ‰€æœ‰è¨ºæ–·é …ç›®é€šéï¼ŒæƒæåŠŸèƒ½æ‡‰è©²æ­£å¸¸</div>';
                html += '<div class="result info">ğŸ’¡ å¦‚æœä»ç„¶ç„¡æ³•æƒæï¼Œè«‹å˜—è©¦ä½¿ç”¨ã€Œé‡è©¦æƒæã€</div>';
            } else {
                html += '<div class="result error"><strong>ç™¼ç¾å•é¡Œ:</strong></div>';
                issues.forEach((issue, index) => {
                    html += `<div class="result error">âŒ ${issue}</div>`;
                    if (suggestions[index]) {
                        html += `<div class="result info">ğŸ’¡ ${suggestions[index]}</div>`;
                    }
                });
                html += '<div class="result info">ğŸ’¡ è«‹è§£æ±ºä¸Šè¿°å•é¡Œå¾Œå†å˜—è©¦æƒæ</div>';
                html += '<div class="result info">ğŸ’¡ æˆ–è€…å˜—è©¦ä½¿ç”¨ã€Œé‡è©¦æƒæã€ä½œç‚ºå‚™é¸æ–¹æ¡ˆ</div>';
            }

            result.innerHTML = html;
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦
        window.onload = function() {
            console.log('QRç¢¼æƒææ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
            console.log('ZXing å¯ç”¨:', typeof ZXing !== 'undefined');
            testBrowserCompatibility();
        };

        // é é¢å¸è¼‰æ™‚æ¸…ç†è³‡æº
        window.onbeforeunload = function() {
            stopScanning();
        };
    </script>
</body>
</html> 