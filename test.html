<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿ç“¦éš† - åŠŸèƒ½æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
        }
        #scanContainer {
            text-align: center;
            margin: 20px 0;
        }
        #scan {
            width: 300px;
            height: 300px;
            border: 2px solid #007bff;
            border-radius: 10px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            font-weight: bold;
        }
        .qr-display {
            margin: 20px 0;
            text-align: center;
        }
        .qr-display img {
            border: 2px solid #007bff;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” é˜¿ç“¦éš†åŠŸèƒ½æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>1. ç€è¦½å™¨ç›¸å®¹æ€§æ¸¬è©¦</h2>
        <button class="btn" onclick="testBrowserCompatibility()">æ¸¬è©¦ç€è¦½å™¨æ”¯æ´</button>
        <div id="browserResult"></div>
    </div>

    <div class="test-section">
        <h2>2. ç›¸æ©Ÿæ¬Šé™æ¸¬è©¦</h2>
        <button class="btn" onclick="testCameraPermission()">æ¸¬è©¦ç›¸æ©Ÿæ¬Šé™</button>
        <div id="cameraResult"></div>
    </div>

    <div class="test-section">
        <h2>3. QRç¢¼ç”Ÿæˆæ¸¬è©¦</h2>
        <button class="btn" onclick="generateTestQR()">ç”Ÿæˆæ¸¬è©¦QRç¢¼</button>
        <div id="qrResult" class="qr-display"></div>
    </div>

    <div class="test-section">
        <h2>4. QRç¢¼æƒææ¸¬è©¦</h2>
        <button class="btn" onclick="startScanning()">é–‹å§‹æƒæ</button>
        <button class="btn" onclick="stopScanning()">åœæ­¢æƒæ</button>
        <div id="scanContainer">
            <div class="status" id="scanStatus">æº–å‚™æƒæ...</div>
            <video id="scan"></video>
        </div>
        <div id="scanResult"></div>
    </div>

    <div class="test-section">
        <h2>5. éŠæˆ²åŠŸèƒ½æ¸¬è©¦</h2>
        <button class="btn" onclick="testGameLogic()">æ¸¬è©¦éŠæˆ²é‚è¼¯</button>
        <div id="gameResult"></div>
    </div>

    <div class="test-section">
        <h2>6. ä¸»ç¨‹å¼æƒææ¸¬è©¦</h2>
        <button onclick="testMainAppScanning()" class="test-btn">6. ä¸»ç¨‹å¼æƒææ¸¬è©¦</button>
        <button onclick="loadSimplePeerManually()" class="test-btn">7. æ‰‹å‹•è¼‰å…¥ SimplePeer</button>
        <div id="mainAppResult" class="result-container"></div>
    </div>

    <!-- å¤–éƒ¨åº« -->
    <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

    <script>
        let codeReader = null;
        let isScanning = false;

        // æ¸¬è©¦ç€è¦½å™¨ç›¸å®¹æ€§
        function testBrowserCompatibility() {
            const result = document.getElementById('browserResult');
            let html = '';

            // æª¢æŸ¥ getUserMedia æ”¯æ´
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                html += '<div class="result success">âœ… getUserMedia API æ”¯æ´</div>';
            } else {
                html += '<div class="result error">âŒ getUserMedia API ä¸æ”¯æ´</div>';
            }

            // æª¢æŸ¥ WebRTC æ”¯æ´
            if (window.RTCPeerConnection || window.webkitRTCPeerConnection) {
                html += '<div class="result success">âœ… WebRTC æ”¯æ´</div>';
            } else {
                html += '<div class="result error">âŒ WebRTC ä¸æ”¯æ´</div>';
            }

            // æª¢æŸ¥ QRCode.js
            if (typeof QRCode !== 'undefined') {
                html += '<div class="result success">âœ… QRCode.js è¼‰å…¥æˆåŠŸ</div>';
            } else {
                html += '<div class="result error">âŒ QRCode.js è¼‰å…¥å¤±æ•—</div>';
            }

            // æª¢æŸ¥ ZXing
            if (typeof ZXing !== 'undefined') {
                html += '<div class="result success">âœ… ZXing è¼‰å…¥æˆåŠŸ</div>';
            } else {
                html += '<div class="result error">âŒ ZXing è¼‰å…¥å¤±æ•—</div>';
            }

            // æª¢æŸ¥ LZString
            if (typeof LZString !== 'undefined') {
                html += '<div class="result success">âœ… LZString è¼‰å…¥æˆåŠŸ</div>';
            } else {
                html += '<div class="result error">âŒ LZString è¼‰å…¥å¤±æ•—</div>';
            }

            result.innerHTML = html;
        }

        // æ¸¬è©¦ç›¸æ©Ÿæ¬Šé™
        async function testCameraPermission() {
            const result = document.getElementById('cameraResult');
            let html = '';

            try {
                html += '<div class="result info">æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...</div>';
                result.innerHTML = html;

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });

                html += '<div class="result success">âœ… ç›¸æ©Ÿæ¬Šé™ç²å¾—æˆåŠŸ</div>';
                
                // æª¢æŸ¥ç›¸æ©Ÿè³‡è¨Š
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) {
                    const capabilities = videoTrack.getCapabilities();
                    html += `<div class="result success">âœ… ç›¸æ©Ÿ: ${videoTrack.label}</div>`;
                    html += `<div class="result success">âœ… è§£æåº¦: ${capabilities.width.max}x${capabilities.height.max}</div>`;
                }

                // åœæ­¢æ¸¬è©¦æµ
                stream.getTracks().forEach(track => track.stop());
                html += '<div class="result success">âœ… ç›¸æ©Ÿæ¸¬è©¦å®Œæˆ</div>';

            } catch (error) {
                html += `<div class="result error">âŒ ç›¸æ©Ÿæ¬Šé™éŒ¯èª¤: ${error.message}</div>`;
                
                if (error.name === 'NotAllowedError') {
                    html += '<div class="result error">ğŸ’¡ è«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±ç›¸æ©Ÿæ¬Šé™</div>';
                } else if (error.name === 'NotFoundError') {
                    html += '<div class="result error">ğŸ’¡ æ‰¾ä¸åˆ°ç›¸æ©Ÿè¨­å‚™</div>';
                } else if (error.name === 'NotSupportedError') {
                    html += '<div class="result error">ğŸ’¡ ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½</div>';
                }
            }

            result.innerHTML = html;
        }

        // ç”Ÿæˆæ¸¬è©¦QRç¢¼
        function generateTestQR() {
            const result = document.getElementById('qrResult');
            
            // ç”Ÿæˆæ¸¬è©¦è³‡æ–™
            const testData = {
                type: 'test',
                timestamp: Date.now(),
                message: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦QRç¢¼'
            };
            
            const compressed = LZString.compressToBase64(JSON.stringify(testData));
            
            // æ¸…é™¤ä¹‹å‰çš„QRç¢¼
            result.innerHTML = '';
            
            // ç”Ÿæˆæ–°çš„QRç¢¼
            const qr = new QRCode(result, {
                text: compressed,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L
            });
            
            result.innerHTML += `<div class="result success">âœ… æ¸¬è©¦QRç¢¼ç”ŸæˆæˆåŠŸ</div>`;
            result.innerHTML += `<div class="result info">æ¸¬è©¦è³‡æ–™: ${compressed.substring(0, 50)}...</div>`;
        }

        // é–‹å§‹æƒæ
        async function startScanning() {
            if (isScanning) {
                return;
            }

            const statusElement = document.getElementById('scanStatus');
            const resultElement = document.getElementById('scanResult');
            const videoElement = document.getElementById('scan');
            
            try {
                isScanning = true;
                statusElement.textContent = 'æ­£åœ¨æª¢æŸ¥æƒæå™¨åº«...';
                resultElement.innerHTML = '';

                // æª¢æŸ¥ ZXing æ˜¯å¦å¯ç”¨
                if (typeof ZXing === 'undefined') {
                    throw new Error('ZXing åº«æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                }

                statusElement.textContent = 'æ­£åœ¨å‰µå»ºæƒæå™¨...';
                
                // å‰µå»º ZXing æƒæå™¨å¯¦ä¾‹
                codeReader = new ZXing.BrowserMultiFormatReader();
                
                statusElement.textContent = 'æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...';
                
                // å•Ÿå‹•æƒæå™¨
                await codeReader.decodeFromVideoDevice(
                    null, // ä½¿ç”¨é è¨­ç›¸æ©Ÿ
                    videoElement,
                    (result, error) => {
                        if (result) {
                            // æƒææˆåŠŸ
                            statusElement.textContent = 'æƒææˆåŠŸï¼';
                            resultElement.innerHTML = `
                                <div class="result success">
                                    <strong>æƒæçµæœ:</strong><br>
                                    <pre>${result.getText()}</pre>
                                </div>
                            `;
                            
                            // å˜—è©¦è§£æè³‡æ–™
                            try {
                                const decompressed = LZString.decompressFromBase64(result.getText());
                                const parsed = JSON.parse(decompressed);
                                resultElement.innerHTML += `
                                    <div class="result success">
                                        <strong>è§£æçµæœ:</strong><br>
                                        <pre>${JSON.stringify(parsed, null, 2)}</pre>
                                    </div>
                                `;
                            } catch (e) {
                                resultElement.innerHTML += `
                                    <div class="result error">
                                        <strong>è§£æå¤±æ•—:</strong> ${e.message}
                                    </div>
                                `;
                            }
                            
                            stopScanning();
                        }
                        
                        if (error && error.name !== 'NotFoundException') {
                            // æƒæéŒ¯èª¤ï¼ˆéè‡´å‘½ï¼‰
                            statusElement.textContent = 'æ­£åœ¨æƒæï¼Œè«‹å°æº–QRç¢¼...';
                        }
                    }
                );

                statusElement.textContent = 'æƒæå™¨å·²å•Ÿå‹•ï¼Œè«‹å°æº–QRç¢¼';

            } catch (error) {
                console.error('æƒæå™¨å•Ÿå‹•å¤±æ•—:', error);
                isScanning = false;
                statusElement.textContent = 'æƒæå™¨å•Ÿå‹•å¤±æ•—';
                resultElement.innerHTML = `
                    <div class="result error">
                        <strong>éŒ¯èª¤:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // åœæ­¢æƒæ
        function stopScanning() {
            const statusElement = document.getElementById('scanStatus');
            const videoElement = document.getElementById('scan');
            
            if (codeReader && isScanning) {
                codeReader.reset();
            }
            
            // åœæ­¢ç›¸æ©Ÿæµ
            if (videoElement.srcObject) {
                const stream = videoElement.srcObject;
                stream.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            
            isScanning = false;
            statusElement.textContent = 'æƒæå·²åœæ­¢';
        }

        // æ¸¬è©¦éŠæˆ²é‚è¼¯
        function testGameLogic() {
            const result = document.getElementById('gameResult');
            let html = '';

            // æ¸¬è©¦ LZString å£“ç¸®/è§£å£“ç¸®
            const testData = { player: "æ¸¬è©¦ç©å®¶", role: "Merlin" };
            const compressed = LZString.compressToBase64(JSON.stringify(testData));
            const decompressed = LZString.decompressFromBase64(compressed);
            const parsed = JSON.parse(decompressed);

            if (parsed.player === testData.player && parsed.role === testData.role) {
                html += '<div class="result success">âœ… LZString å£“ç¸®/è§£å£“ç¸®æ¸¬è©¦é€šé</div>';
            } else {
                html += '<div class="result error">âŒ LZString å£“ç¸®/è§£å£“ç¸®æ¸¬è©¦å¤±æ•—</div>';
            }

            // æ¸¬è©¦ QRCode ç”Ÿæˆ
            try {
                const qr = new QRCode(document.createElement('div'), {
                    text: compressed,
                    width: 100,
                    height: 100
                });
                html += '<div class="result success">âœ… QRCode ç”Ÿæˆæ¸¬è©¦é€šé</div>';
            } catch (error) {
                html += '<div class="result error">âŒ QRCode ç”Ÿæˆæ¸¬è©¦å¤±æ•—</div>';
            }

            result.innerHTML = html;
        }

        // æ¸¬è©¦ä¸»ç¨‹å¼æƒæåŠŸèƒ½
        function testMainAppScanning() {
            const result = document.getElementById('mainAppResult');
            let html = '';

            // æª¢æŸ¥å¿…è¦çš„åº«
            if (typeof ZXing === 'undefined') {
                html += '<div class="result error">âŒ ZXing åº«æœªè¼‰å…¥</div>';
            } else {
                html += '<div class="result success">âœ… ZXing åº«å·²è¼‰å…¥</div>';
            }

            if (typeof QRCode === 'undefined') {
                html += '<div class="result error">âŒ QRCode.js åº«æœªè¼‰å…¥</div>';
            } else {
                html += '<div class="result success">âœ… QRCode.js åº«å·²è¼‰å…¥</div>';
            }

            if (typeof LZString === 'undefined') {
                html += '<div class="result error">âŒ LZString åº«æœªè¼‰å…¥</div>';
            } else {
                html += '<div class="result success">âœ… LZString åº«å·²è¼‰å…¥</div>';
            }

            if (typeof SimplePeer === 'undefined') {
                html += '<div class="result error">âŒ SimplePeer åº«æœªè¼‰å…¥</div>';
                html += '<div class="result info">ğŸ’¡ è§£æ±ºæ–¹æ¡ˆï¼š</div>';
                html += '<div class="result info">1. æª¢æŸ¥ç¶²è·¯é€£æ¥</div>';
                html += '<div class="result info">2. é‡æ–°è¼‰å…¥é é¢</div>';
                html += '<div class="result info">3. å˜—è©¦ä½¿ç”¨ä¸åŒçš„CDN</div>';
                html += '<div class="result info">4. æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°æ˜¯å¦æœ‰éŒ¯èª¤</div>';
            } else {
                html += '<div class="result success">âœ… SimplePeer åº«å·²è¼‰å…¥</div>';
                
                // æ¸¬è©¦ SimplePeer åŠŸèƒ½
                try {
                    const peer = new SimplePeer({ initiator: true, trickle: false });
                    html += '<div class="result success">âœ… SimplePeer å¯¦ä¾‹å‰µå»ºæˆåŠŸ</div>';
                    
                    // æ¸¬è©¦ signal äº‹ä»¶
                    let signalReceived = false;
                    peer.on('signal', () => {
                        signalReceived = true;
                    });
                    
                    setTimeout(() => {
                        if (signalReceived) {
                            html += '<div class="result success">âœ… SimplePeer signal äº‹ä»¶æ­£å¸¸</div>';
                        } else {
                            html += '<div class="result error">âŒ SimplePeer signal äº‹ä»¶ç•°å¸¸</div>';
                        }
                        result.innerHTML = html;
                    }, 1000);
                    
                } catch (error) {
                    html += `<div class="result error">âŒ SimplePeer å¯¦ä¾‹å‰µå»ºå¤±æ•—: ${error.message}</div>`;
                }
            }

            // æ¸¬è©¦ ZXing æƒæå™¨å‰µå»º
            try {
                const codeReader = new ZXing.BrowserMultiFormatReader();
                html += '<div class="result success">âœ… ZXing æƒæå™¨å‰µå»ºæˆåŠŸ</div>';
            } catch (error) {
                html += `<div class="result error">âŒ ZXing æƒæå™¨å‰µå»ºå¤±æ•—: ${error.message}</div>`;
            }

            // æ¸¬è©¦ QRCode ç”Ÿæˆå™¨å‰µå»º
            try {
                const qr = new QRCode(document.createElement('div'), {
                    text: 'test',
                    width: 100,
                    height: 100
                });
                html += '<div class="result success">âœ… QRCode ç”Ÿæˆå™¨å‰µå»ºæˆåŠŸ</div>';
            } catch (error) {
                html += `<div class="result error">âŒ QRCode ç”Ÿæˆå™¨å‰µå»ºå¤±æ•—: ${error.message}</div>`;
            }

            result.innerHTML = html;
        }

        // æ‰‹å‹•è¼‰å…¥ SimplePeer
        function loadSimplePeerManually() {
            const result = document.getElementById('mainAppResult');
            result.innerHTML = '<div class="result info">ğŸ”„ æ­£åœ¨æ‰‹å‹•è¼‰å…¥ SimplePeer...</div>';

            // å˜—è©¦ä¸åŒçš„ CDN
            const cdnUrls = [
                'https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js',
                'https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js'
            ];

            function tryLoadCDN(index) {
                if (index >= cdnUrls.length) {
                    result.innerHTML = '<div class="result error">âŒ æ‰€æœ‰ CDN éƒ½è¼‰å…¥å¤±æ•—</div>';
                    return;
                }

                const script = document.createElement('script');
                script.src = cdnUrls[index];
                script.onload = () => {
                    result.innerHTML = '<div class="result success">âœ… SimplePeer è¼‰å…¥æˆåŠŸï¼</div>';
                    setTimeout(() => {
                        testMainAppScanning();
                    }, 500);
                };
                script.onerror = () => {
                    console.log(`CDN ${index + 1} è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦ä¸‹ä¸€å€‹...`);
                    tryLoadCDN(index + 1);
                };
                document.head.appendChild(script);
            }

            tryLoadCDN(0);
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦
        window.onload = function() {
            console.log('é˜¿ç“¦éš†åŠŸèƒ½æ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
            testBrowserCompatibility();
        };

        // é é¢å¸è¼‰æ™‚æ¸…ç†è³‡æº
        window.onbeforeunload = function() {
            stopScanning();
        };
    </script>
</body>
</html> 