# 阿瓦隆遊戲 - 手機版

一個基於WebRTC的離線多人阿瓦隆遊戲，支援QR碼配對連接。

## 版本更新

### v1.0.18 - 全新UI架構
- 重新設計UI架構，分為三個主要區域：
  - **房間區域**：玩家加入、聊天、準備遊戲
  - **遊戲操作區域**：遊戲進行中的操作介面
  - **遊戲查看區域**：遊戲統計和歷史記錄
- 房主專用功能：加入玩家、開始遊戲
- 房間聊天功能
- 玩家頭像顯示，支援角色識別（梅林可看到壞人紅點）
- 遊戲統計表格，包含任務進度、投票記錄、玩家狀態

### v1.0.17 - WebRTC連接優化
- 修復信令狀態檢查過於嚴格的問題
- 改進錯誤處理和重連機制
- 添加連接狀態監控和超時機制
- 修復事件處理器重複綁定問題
- 創建test-webrtc.html測試頁面

## 功能特色

### 連接方式
- **WebRTC P2P連接**：無需伺服器，直接點對點連接
- **QR碼配對**：掃描QR碼快速加入遊戲
- **手動輸入**：支援手動貼上QR碼內容

### 遊戲功能
- 支援5-10人遊戲
- 完整角色系統（梅林、派西維爾、忠誠的僕人、莫甘娜、莫德雷德、奧伯倫、刺客）
- 5輪任務機制
- 投票系統
- 梅林刺殺機制

### UI特色
- 響應式設計，手機優先
- 直觀的遊戲流程
- 即時聊天功能
- 遊戲統計查看
- 角色識別顯示

## 使用方式

1. **創建房間**：點擊「創建房間」按鈕
2. **加入房間**：點擊「加入房間」按鈕，掃描房主的QR碼
3. **房間準備**：在房間區域聊天、等待其他玩家
4. **開始遊戲**：房主點擊「開始遊戲」按鈕
5. **遊戲進行**：在遊戲操作區域進行遊戲
6. **查看統計**：點擊「查看遊戲」按鈕查看統計

## 技術架構

### 前端技術
- HTML5 + CSS3 + JavaScript (ES6+)
- WebRTC (simple-peer)
- QR碼生成/掃描 (ZXing)
- 資料壓縮 (LZ-string)

### 架構設計
- **資料傳輸層** (Transport Layer)：處理WebRTC連接和訊息傳輸
- **遊戲邏輯層** (Game Logic)：處理遊戲規則和狀態管理
- **UI控制層** (UI Controller)：處理使用者介面和事件

## 檔案結構

```
阿瓦隆/
├── index.html          # 主頁面
├── app.js              # UI控制層
├── game.js             # 遊戲邏輯層
├── transport.js        # 資料傳輸層
├── style.css           # 樣式檔案
├── test-webrtc.html    # WebRTC測試頁面
└── README.md           # 說明文件
```

## 瀏覽器支援

- Chrome 60+
- Firefox 55+
- Safari 11+
- Edge 79+

## 注意事項

- 需要HTTPS環境或localhost才能使用相機功能
- 建議使用Chrome瀏覽器獲得最佳體驗
- 確保相機權限已開啟
- 網路連接穩定以確保WebRTC連接成功

## ✨ 特色功能

- 📱 **手機優先設計** - 專為手機使用優化
- 🔗 **離線配對** - 使用QR碼掃描，無需網路連接
- 🎮 **完整遊戲規則** - 支援5-10人遊戲，包含所有角色
- 🎨 **美觀介面** - 現代化UI設計，中世紀風格
- 📊 **即時同步** - 遊戲狀態即時更新
- 🔒 **安全可靠** - 本地連接，資料不外洩
- 🏗️ **模組化架構** - 三層分離設計，易於維護和擴展

## 🚀 快速開始

### 1. 部署到GitHub Pages

1. 將所有檔案上傳到GitHub倉庫
2. 在倉庫設定中啟用GitHub Pages
3. 選擇主分支作為來源
4. 等待部署完成

### 2. 開始遊戲

1. **房主操作**：
   - 打開網頁
   - 點擊「🏠 創建房間」
   - 等待QR碼生成
   - 讓其他玩家掃描QR碼

2. **玩家操作**：
   - 打開相同網址
   - 點擊「🔗 加入房間」
   - 掃描房主的QR碼
   - 等待連接成功

3. **遊戲流程**：
   - 等待所有玩家加入（最少5人）
   - 系統自動分配角色
   - 開始5輪任務
   - 好人陣營需要3次任務成功獲勝
   - 壞人陣營需要3次任務失敗獲勝

## 🎯 遊戲規則

### 角色介紹

**好人陣營**：
- **梅林 (Merlin)** - 知道所有壞人身份（除了莫德雷德）
- **派西維爾 (Percival)** - 知道梅林和莫甘娜的身份
- **忠誠的僕人 (Loyal Servant)** - 普通好人

**壞人陣營**：
- **莫甘娜 (Morgana)** - 假裝是梅林來迷惑派西維爾
- **莫德雷德 (Mordred)** - 梅林看不到他的身份
- **奧伯倫 (Oberon)** - 不知道其他壞人的身份
- **刺客 (Assassin)** - 遊戲結束後可以刺殺梅林

### 遊戲流程

1. **角色分配** - 系統隨機分配角色
2. **任務階段** - 5輪任務，每輪需要不同數量的成員
3. **投票階段** - 被選中的成員進行秘密投票
4. **結果公布** - 顯示任務成功或失敗
5. **勝負判定** - 好人3勝或壞人3敗
6. **刺殺階段** - 壞人獲勝時可刺殺梅林

## 🛠 技術架構

### 三層分離式架構

```
avalon/
├── index.html          # 主頁面 (UI層)
├── transport.js        # 資料傳輸層
├── game.js            # 遊戲邏輯層
├── app.js             # UI控制層
├── README.md          # 說明文件
├── test.html          # 功能測試
└── 阿瓦隆需求.txt      # 需求文件
```

#### 1. 資料傳輸層 (Transport Layer) - `transport.js`
- WebRTC P2P連接管理
- JSON格式訊息傳輸
- LZ-string壓縮
- 抽象化介面，支援未來擴展
- 連接狀態管理
- 錯誤處理機制

#### 2. 遊戲邏輯層 (Game Logic) - `game.js`
- 狀態機管理
- 角色分配算法
- 投票計票系統
- 勝負判定邏輯
- 遊戲事件系統
- 規則驗證

#### 3. UI控制層 (User Interface) - `app.js`
- 響應式設計
- 手機優先佈局
- 即時狀態更新
- 直觀操作流程
- 事件處理

### 使用技術

- **前端**：HTML5, CSS3, JavaScript (ES6+)
- **通訊**：WebRTC (simple-peer)
- **QR碼**：QRCode.js, ZXing
- **壓縮**：LZ-string
- **部署**：GitHub Pages

## 📱 使用說明

### 系統需求

- 支援WebRTC的現代瀏覽器
- 手機相機權限（掃描QR碼）
- 同一Wi-Fi網路（推薦）

### 瀏覽器支援

- ✅ Chrome (推薦)
- ✅ Firefox
- ✅ Safari (iOS 11+)
- ✅ Edge

### 注意事項

1. **相機權限** - 首次使用需要允許相機權限
2. **網路環境** - 建議在同一Wi-Fi下使用
3. **人數限制** - 支援5-10人遊戲
4. **斷線重連** - 目前不支援自動重連

### QR碼掃描故障排除

如果遇到QR碼掃描問題，請按照以下步驟進行診斷：

#### 1. 使用診斷工具
- 打開 `qr-test.html` 頁面
- 點擊「執行完整診斷」按鈕
- 根據診斷結果解決問題

#### 2. 常見問題及解決方案

**問題：掃描器啟動失敗**
- 確認已允許相機權限
- 檢查瀏覽器是否支援相機功能
- 確認ZXing庫已正確載入
- 嘗試使用「重試掃描」

**問題：相機權限被拒絕**
- 點擊網址列左側的相機圖示允許權限
- 或在瀏覽器設定中手動允許相機權限
- 重新載入頁面

**問題：找不到相機設備**
- 確認設備有相機功能
- 檢查相機是否被其他應用程式佔用
- 關閉其他使用相機的應用程式

**問題：瀏覽器不支援**
- 更新瀏覽器到最新版本
- 使用 Chrome、Firefox、Safari 或 Edge
- 確認瀏覽器版本支援 WebRTC

#### 3. 備選掃描方案

如果主要掃描功能無法使用，可以嘗試：

1. **重試掃描**：
   - 點擊「重試掃描」按鈕
   - 重新啟動掃描器

2. **手動輸入**：
   - 如果QR碼包含簡單文字
   - 可以手動輸入連接資訊

#### 4. GitHub Pages 特定問題

**問題：在GitHub Pages上掃描失敗**
- 確認使用HTTPS網址（https://username.github.io/repository）
- 檢查是否為正確的入口頁面
- 確認所有檔案都已正確上傳

**問題：Chrome移動版掃描問題**
- 更新Chrome到最新版本
- 清除瀏覽器快取
- 重新載入頁面
- 確認相機權限已允許

#### 5. 技術要求

- **HTTPS連接**：相機功能需要HTTPS（localhost除外）
- **現代瀏覽器**：Chrome 53+、Firefox 36+、Safari 11+
- **相機權限**：需要用戶明確允許相機權限
- **網路連接**：用於載入外部庫（ZXing、QRCode.js等）
- **GitHub Pages**：需要正確的HTTPS設定

#### 6. SimplePeer 載入問題

**問題：SimplePeer 庫載入失敗**
- 檢查網路連接是否正常
- 重新載入頁面
- 使用 `test.html` 頁面的「手動載入 SimplePeer」功能
- 檢查瀏覽器控制台是否有錯誤訊息
- 嘗試使用不同的瀏覽器

**問題：加入房間無反應**
- 確認 SimplePeer 庫已正確載入
- 檢查瀏覽器是否支援 WebRTC
- 確認相機權限已允許
- 使用 `test.html` 進行完整診斷

**問題：WebRTC 連接失敗**
- 確認在同一網路環境下
- 檢查防火牆設定
- 嘗試使用不同的網路
- 確認瀏覽器版本支援 WebRTC

## 🔧 開發說明

### 檔案結構說明

```
avalon/
├── index.html          # 主頁面，包含UI結構和樣式
├── transport.js        # 傳輸層：處理WebRTC連接和訊息傳輸
├── game.js            # 遊戲邏輯層：處理遊戲規則和狀態
├── app.js             # UI控制層：處理使用者介面和事件
├── test.html          # 功能測試頁面
├── README.md          # 專案說明文件
└── 阿瓦隆需求.txt      # 詳細需求文件
```

### 模組化優勢

1. **易於維護** - 各層職責明確，修改時不會互相影響
2. **便於測試** - 可以獨立測試每個模組
3. **擴展性強** - 可以輕鬆替換或擴展任何一層
4. **程式碼重用** - 各層可以在其他專案中重用

### 擴展功能

1. **線上模式** - 替換 `transport.js` 中的WebRTC為WebSocket
2. **多房間** - 擴展 `game.js` 支援多個遊戲房間
3. **語音聊天** - 在 `transport.js` 中添加語音通訊
4. **統計功能** - 在 `game.js` 中添加遊戲記錄
5. **自定義規則** - 修改 `game.js` 中的遊戲參數

### 開發指南

#### 添加新功能
1. 在對應的層中添加功能
2. 使用事件系統進行層間通訊
3. 保持各層的獨立性

#### 修改遊戲規則
1. 主要修改 `game.js` 檔案
2. 更新角色配置或任務規則
3. 測試確保邏輯正確

#### 更換傳輸方式
1. 修改 `transport.js` 檔案
2. 保持相同的介面方法
3. 更新連接邏輯

### 貢獻指南

歡迎提交Issue和Pull Request來改善這個專案！

## 📄 授權

本專案採用MIT授權條款。

## 🤝 致謝

- 感謝阿瓦隆桌遊的原創者
- 感謝所有開源庫的貢獻者
- 感謝測試和回饋的玩家們

---

**享受阿瓦隆的樂趣！** 🎮✨ 